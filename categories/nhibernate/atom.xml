<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: nhibernate | sharp bites]]></title>
  <link href="http://www.sharpbites.com/categories/nhibernate/atom.xml" rel="self"/>
  <link href="http://www.sharpbites.com/"/>
  <updated>2012-03-05T22:58:24+01:00</updated>
  <id>http://www.sharpbites.com/</id>
  <author>
    <name><![CDATA[alberto]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[AltNerDinner: Part 4. Introducing NHibernate. Because POCO is enough]]></title>
    <link href="http://www.sharpbites.com/2009/10/19/altnerdinner-part-4-introducing/"/>
    <updated>2009-10-19T00:00:00+02:00</updated>
    <id>http://www.sharpbites.com/2009/10/19/altnerdinner-part-4-introducing</id>
    <content type="html"><![CDATA[<div class='post'>
<p>It's time already to introduce a proper persistence solution. NHibernate can be a little intimidating at first for a new-comer, but I undoubtedly think it's the way to go. And it's not really more difficult than the other contenders anymore. Its two major drawbacks (hand writing all that XMhelL mapping and not strongly typed queries) are solved (or in serious process of it) by Fluent NHibernate and NHibernate.Linq.</p>  <p>Other than that, the only difficulty relies in learning a few concepts inherent to OR/Ms. Most notably the <a href="http://martinfowler.com/eaaCatalog/unitOfWork.html">Unit of Work</a> pattern and <a href="http://martinfowler.com/eaaCatalog/lazyLoad.html">Lazy Loading</a>, and all the stuff around them (namely repositories, query objects, persistence ignorance, POCOs, DTOs, entities/value objects and equality, inheritance mapping, dynamic proxies, caching, anemic domains, active record, transactions, concurrency, session lifetime, unit testing, select n+1 problems and other pitfalls to avoid,&#160; ...). [NOTE: If you need more info on this topics I'd recommend you to visit the <a href="http://nhforge.org/">official nhibernate site</a>.]</p>  <p>Sounds scary? It might seem using an OR/M brings in more problems that the ones it solves, but I don't think it is the case, except for maybe the most trivial apps (like AltNerdDinner, hehe, I know). Even if you are writing a relatively simple app, you can still greatly benefit from using NHibernate (or Active Record on top of it). If your app has inherent complexity, well, of course you'll have to do your homework and learn a few concepts, but that's not your OR/M's fault. Using a hand-rolled DAL won't make your problems go away (quite the opposite, I'd dare to say).</p>  <p>As I said, most (if not all) of this problems exist in all OR/M, it's just that some of them somehow try to hide this complexity in one or another way. The problem is, this is a can of worms that can lead to very bad practices and slap on your face at any moment. And this is were I think this is were NHibernate excels at, its flexibility. It gets out of your way.</p>  <h4>Ok, enough talking! Show me the code!</h4>  <p>To use NHibernate and NH.Linq we need to add a reference in our project to the following dll's: NHibernate, NHibernate.Linq, FluentNHibernate (if we hadn't already) and lastly NHibernate.ByteCode.Castle if we want to use Castle's dynamic proxy as our proxy generator of choice.</p>  <p>Here is the code for my DinnerRepository implementation using NHibernate:</p>  <pre class="code"><span style="color: blue">public class </span><span style="color: #2b91af">NhDinnerRepository </span>: <span style="color: #2b91af">IDinnerRepository<br /></span>{<br />    <span style="color: blue">private readonly </span><span style="color: #2b91af">ISession </span>_session;<br /><br />    <span style="color: blue">public </span>NhDinnerRepository(<span style="color: #2b91af">ISession </span>session)<br />    {<br />        _session = session;<br />    }<br /><br />    <span style="color: blue">private </span><span style="color: #2b91af">INHibernateQueryable</span>&lt;<span style="color: #2b91af">Dinner</span>&gt; GetDbContext()<br />    {<br />        <span style="color: blue">return </span>_session.Linq&lt;<span style="color: #2b91af">Dinner</span>&gt;();<br />    }<br /><br />    <span style="color: blue">public </span><span style="color: #2b91af">IQueryable</span>&lt;<span style="color: #2b91af">Dinner</span>&gt; FindAllDinners()<br />    {<br />        <span style="color: blue">return </span>GetDbContext().AsQueryable();<br />    }<br /><br />    <span style="color: blue">public </span><span style="color: #2b91af">IQueryable</span>&lt;<span style="color: #2b91af">Dinner</span>&gt; FindByLocation(<span style="color: blue">float </span>latitude, <span style="color: blue">float </span>longitude)<br />    {<br />        <span style="color: blue">return </span>GetDbContext().Where(d =&gt; d.Distance(latitude, longitude) &lt; 100).AsQueryable();<br />    }<br /><br />    <span style="color: blue">public </span><span style="color: #2b91af">IQueryable</span>&lt;<span style="color: #2b91af">Dinner</span>&gt; FindUpcomingDinners()<br />    {<br />        <span style="color: blue">return from </span>dinner <span style="color: blue">in </span>GetDbContext()<br />               <span style="color: blue">where </span>dinner.EventDate &gt; <span style="color: #2b91af">DateTime</span>.Now<br />               <span style="color: blue">orderby </span>dinner.EventDate<br />               <span style="color: blue">select </span>dinner;<br />    }<br /><br />    <span style="color: blue">public </span><span style="color: #2b91af">Dinner </span>GetDinner(<span style="color: blue">int </span>id)<br />    {<br />        <span style="color: blue">return </span>GetDbContext().SingleOrDefault(d =&gt; d.DinnerID == id);<br />    }<br /><br />    <span style="color: blue">public void </span>Save(<span style="color: #2b91af">Dinner </span>dinner)<br />    {<br />        <span style="color: blue">if </span>(!dinner.IsValid)<br />        {<br />            <span style="color: blue">throw new </span><span style="color: #2b91af">ApplicationException</span>(<span style="color: #a31515">&quot;Rule violations&quot;</span>);<br />        }<br /><br />        _session.SaveOrUpdate(dinner);<br />    }<br /><br />    <span style="color: blue">public void </span>Delete(<span style="color: #2b91af">Dinner </span>dinner)<br />    {<br />        _session.Delete(dinner);<br />    }</pre><br /><br /><p>As you see, I am returning IQueryable&lt;Dinner&gt; instead of traditional .NET collections. Some people think <a href="http://mikehadlow.blogspot.com/2009/01/should-my-repository-expose-iqueryable.html">IQueryable is the best thing since slice bread</a>, others are <a href="http://ayende.com/Blog/archive/2009/04/17/repository-is-the-new-singleton.aspx">ditching repositories entirely</a>, some prefer <a href="http://www.udidahan.com/2007/03/28/query-objects-vs-methods-on-a-repository/">using query objects</a>, others advocate for <a href="http://codebetter.com/blogs/gregyoung/archive/2009/01/16/ddd-the-generic-repository.aspx">explicit repositories</a>, some use <a href="http://serialseb.blogspot.com/2009/08/nhibernate-repository-that-oren-wont.html">generic ones</a> and I just don't know yet, but decided to go at least with repositories because I want to take <a href="http://www.udidahan.com/2008/02/15/from-crud-to-domain-driven-fluency/">control of how entities are persisted</a>.</p><br /><br /><p>To instantiate my NHibernate repository, I need to supply it with an ISession. I <a href="http://ayende.com/Blog/archive/2008/07/24/How-to-review-NHibernate-application.aspx">don't create the ISession inside the repository</a>, since this is considered a bad practice. Instead, I create a new Session per request. To do that, I expected I would have some infrastructure in place in MvcContrib, but that was not the case. <a href="http://jeffreypalermo.com">Jeffrey Palermo</a> posted a <a href="http://jeffreypalermo.com/blog/use-this-nhibernate-wrapper-to-keep-your-repository-classes-simple/">NHibernate wrapper to manage ISession</a>, but I thought that class had too many responsibilities, so I separated it in the following.</p><br /><br /><pre class="code"><span style="color: blue">public class </span><span style="color: #2b91af">SessionFactoryBuilder<br /></span>{<br />    <span style="color: blue">private static </span><span style="color: #2b91af">ISessionFactory </span>_sessionFactory;<br /><br />    <span style="color: blue">private readonly </span><span style="color: #2b91af">IPersistenceConfigurer </span>_dbConfiguration;<br /><br />    <span style="color: blue">public </span>SessionFactoryBuilder(<span style="color: #2b91af">IPersistenceConfigurer </span>dbConfiguration)<br />    {<br />        _dbConfiguration = dbConfiguration;<br />    }<br /><br />    <span style="color: blue">public </span><span style="color: #2b91af">ISessionFactory </span>Build()<br />    {<br />        <span style="color: blue">if </span>(_sessionFactory == <span style="color: blue">null</span>)<br />        {<br />            _sessionFactory  = GetDbConfiguration().BuildSessionFactory();   <br />        }<br /><br />        <span style="color: blue">return </span>_sessionFactory;<br />    }<br /><br />    <span style="color: blue">public </span><span style="color: #2b91af">Configuration </span>GetDbConfiguration()<br />    {<br />        <span style="color: blue">return </span><span style="color: #2b91af">Fluently</span>.Configure()<br />                .Mappings(m =&gt; m.FluentMappings.AddFromAssemblyOf&lt;<span style="color: #2b91af">Dinner</span>&gt;())<br />                .Database(_dbConfiguration)                    <br />                .BuildConfiguration();<br />    }<br />}</pre><br /><br /><p>This builds the session factory and also returns the configuration (useful to create the schema). It needs an IPersistenceConfigurer, which I supply from the constructor, in order to be able to switch between different configurations (i.e. MSSQL and SQLite), as shown below:</p><br /><br /><pre class="code"><span style="color: blue">public class </span><span style="color: #2b91af">MsSqlPersistenceConfigurerFactory </span>: <span style="color: #2b91af">IPersistenceConfigurerFactory<br /></span>{<br />    <span style="color: blue">private string </span>_connectionString;<br /><br />    <span style="color: blue">public </span>MsSqlPersistenceConfigurerFactory(<span style="color: blue">string </span>connectionString)<br />    {<br />        _connectionString = connectionString;<br />    }<br /><br />    <span style="color: blue">public </span><span style="color: #2b91af">IPersistenceConfigurer </span>GetPersistenceConfigurer()<br />    {<br />        <span style="color: blue">return </span><span style="color: #2b91af">MsSqlConfiguration</span>.MsSql2005<br />                .ConnectionString(c =&gt; c.Is(_connectionString))<br />                .ShowSql()<br />                .FormatSql()<br />                .ProxyFactoryFactory&lt;<span style="color: #2b91af">ProxyFactoryFactory</span>&gt;();<br />    }<br />}</pre><br /><br /><h4>Life of a Session</h4><br /><br /><p>We need to create the aforementioned ISession somehow. In Web applications, it's generally a good practice to create a new Session on every request. For that, Ayende recently <a href="http://ayende.com/Blog/archive/2009/08/05/do-you-need-a-framework.aspx">suggested</a> to just stick it in the global.asax, but I prefer to put it in a separate&#160; IHttpModule.</p><br /><br /><pre class="code"><span style="color: blue">public class </span><span style="color: #2b91af">NhSessionPerRequestModule </span>: <span style="color: #2b91af">IHttpModule<br /></span>{<br />    <span style="color: blue">private readonly </span><span style="color: #2b91af">ISessionFactory </span>_sessionFactory;<br /><br />    <span style="color: blue">public </span>NhSessionPerRequestModule(<span style="color: #2b91af">ISessionFactory </span>sessionFactory)<br />    {<br />        _sessionFactory = sessionFactory;<br />    }<br />    <span style="color: blue">public void </span>Init(<span style="color: #2b91af">HttpApplication </span>application)<br />    {<br />        application.BeginRequest += <span style="color: blue">delegate<br />                                    </span>{<br />                                        CurrentSession = _sessionFactory.OpenSession();<br />                                    };<br /><br />        application.EndRequest += <span style="color: blue">delegate<br />                                  </span>{<br />                                      <span style="color: blue">if </span>(CurrentSession != <span style="color: blue">null</span>)<br />                                      {<br />                                          CurrentSession.Dispose();<br />                                      }<br />                                  };<br />    }<br /><br />    <span style="color: blue">public static </span><span style="color: #2b91af">ISession </span>CurrentSession<br />    {<br />        <span style="color: blue">get </span>{ <span style="color: blue">return </span>(<span style="color: #2b91af">ISession</span>)<span style="color: #2b91af">HttpContext</span>.Current.Items[<span style="color: #a31515">&quot;current.session&quot;</span>]; }<br />        <span style="color: blue">private set </span>{ <span style="color: #2b91af">HttpContext</span>.Current.Items[<span style="color: #a31515">&quot;current.session&quot;</span>] = <span style="color: blue">value</span>; }<br />    }<br /><br />    <span style="color: blue">public void </span>Dispose()<br />    {        <br />    }<br />}</pre><br /><a href="http://11011.net/software/vspaste"></a><br /><br /><p>In my Global.asax, I configure it as follows:</p><br /><br /><pre class="code"><span style="color: blue">private static readonly </span><span style="color: #2b91af">ISessionFactory </span>SessionFactory = CreateSessionFactory();<br /><span style="color: blue">private static </span><span style="color: #2b91af">IWindsorContainer </span>_container;<br /><br /><span style="color: blue">private static </span><span style="color: #2b91af">ISessionFactory </span>CreateSessionFactory()<br />{<br />    <span style="color: blue">string </span>connString = <span style="color: #2b91af">ConfigurationManager</span>.ConnectionStrings[<span style="color: #a31515">&quot;AltNerdDinner&quot;</span>].ConnectionString;<br />    <span style="color: blue">return new </span><span style="color: #2b91af">SessionFactoryBuilder</span>(<br />            <span style="color: blue">new </span><span style="color: #2b91af">MsSqlPersistenceConfigurerFactory</span>(connString)<br />                    .GetPersistenceConfigurer())<br />            .Build();<br />}<br /><br /><span style="color: blue">private readonly </span><span style="color: #2b91af">NhSessionLifetimeModule </span>_nhSessionLifetimeModule =<br />        <span style="color: blue">new </span><span style="color: #2b91af">NhSessionLifetimeModule</span>(SessionFactory);<br /><br /><span style="color: blue">public override void </span>Init()<br />{<br />    <span style="color: blue">base</span>.Init();<br />    _nhSessionLifetimeModule.Init(<span style="color: blue">this</span>);<br />}</pre><br /><br /><p>Lastly, this is my current configuration of the container in order to register the components:</p><br /><br /><pre class="code"><span style="color: blue">private void </span>RegisterComponents()<br /> {<br />     _container = <span style="color: blue">new </span><span style="color: #2b91af">WindsorContainer</span>();<br />     _container.AddFacility&lt;<span style="color: #2b91af">FactorySupportFacility</span>&gt;();<br /><br />     <span style="color: #2b91af">ControllerBuilder</span>.Current.SetControllerFactory(<br />         <span style="color: blue">new </span><span style="color: #2b91af">WindsorControllerFactory</span>(_container));<br /><br />     _container.Register(<br />             <span style="color: #2b91af">Component</span>.For&lt;<span style="color: #2b91af">ISession</span>&gt;()<br />                     .UsingFactoryMethod(() =&gt; <span style="color: #2b91af">NhSessionLifetimeModule</span>.CurrentSession)<br />                     .LifeStyle.Transient);<br />  <br />     _container.Register(<br />             <span style="color: #2b91af">Component</span>.For&lt;<span style="color: #2b91af">IDinnerRepository</span>&gt;()<br />                     .ImplementedBy&lt;<span style="color: #2b91af">NhDinnerRepository</span>&gt;().LifeStyle.Transient);<br /><br />     _container.RegisterControllers(<span style="color: #2b91af">Assembly</span>.GetExecutingAssembly());<br /> }</pre>  </div>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[AltNerdDinner: Part 3. Introducing Fluent NHibernate. Mapping, the easy way]]></title>
    <link href="http://www.sharpbites.com/2009/10/14/altnerddinner-part-3-introducing-fluent/"/>
    <updated>2009-10-14T00:00:00+02:00</updated>
    <id>http://www.sharpbites.com/2009/10/14/altnerddinner-part-3-introducing-fluent</id>
    <content type="html"><![CDATA[<div class='post'>
<p><em>This is part 3 of the <a href="http://sharpbites.blogspot.com/2009/08/introducing-altnerddinner.html">AltNerdDinner</a> Series.</em></p>  <p>One of the things I always disliked the most when exploring NHibernate was the need of declaring all the mappings in XMhelL. And don't know about you, but that's not something I want to be spending my time creating, modifying, hand-refactoring or debugging tedious tons of this crap.</p>  <p>Fast forward to 2008 and say hello to <a href="http://fluentnhibernate.org/">Fluent NHibernate</a>. (And don't forget to thank <a href="http://codebetter.com/blogs/jeremy.miller/">Jeremy Miller</a>, <a href="http://blog.jagregory.com/">James Gregory</a> <a href="http://code.google.com/p/fluent-nhibernate/people/list"><em>et al</em></a>!). It is basically a way to programmatically declare the mappings, allowing you to go from this:</p>  <pre class="code"><span style="color: blue">&lt;?</span><span style="color: #a31515">xml </span><span style="color: red">version</span><span style="color: blue">=</span>&quot;<span style="color: blue">1.0</span>&quot; <span style="color: red">encoding</span><span style="color: blue">=</span>&quot;<span style="color: blue">utf-8</span>&quot; <span style="color: blue">?&gt;  <br />&lt;</span><span style="color: #a31515">hibernate-mapping </span><span style="color: red">xmlns</span><span style="color: blue">=</span>&quot;<span style="color: blue">urn:nhibernate-mapping-2.2</span>&quot;  <br />  <span style="color: red">namespace</span><span style="color: blue">=</span>&quot;<span style="color: blue">QuickStart</span>&quot; <span style="color: red">assembly</span><span style="color: blue">=</span>&quot;<span style="color: blue">QuickStart</span>&quot;<span style="color: blue">&gt;  <br /> <br />  &lt;</span><span style="color: #a31515">class </span><span style="color: red">name</span><span style="color: blue">=</span>&quot;<span style="color: blue">Cat</span>&quot; <span style="color: red">table</span><span style="color: blue">=</span>&quot;<span style="color: blue">Cat</span>&quot;<span style="color: blue">&gt;  <br />    &lt;</span><span style="color: #a31515">id </span><span style="color: red">name</span><span style="color: blue">=</span>&quot;<span style="color: blue">Id</span>&quot;<span style="color: blue">&gt;  <br />      &lt;</span><span style="color: #a31515">generator </span><span style="color: red">class</span><span style="color: blue">=</span>&quot;<span style="color: blue">identity</span>&quot; <span style="color: blue">/&gt;  <br />    &lt;/</span><span style="color: #a31515">id</span><span style="color: blue">&gt;  <br /> <br />    &lt;</span><span style="color: #a31515">property </span><span style="color: red">name</span><span style="color: blue">=</span>&quot;<span style="color: blue">Name</span>&quot;<span style="color: blue">&gt;  <br />      &lt;</span><span style="color: #a31515">column </span><span style="color: red">name</span><span style="color: blue">=</span>&quot;<span style="color: blue">Name</span>&quot; <span style="color: red">length</span><span style="color: blue">=</span>&quot;<span style="color: blue">16</span>&quot; <span style="color: red">not-null</span><span style="color: blue">=</span>&quot;<span style="color: blue">true</span>&quot; <span style="color: blue">/&gt;  <br />    &lt;/</span><span style="color: #a31515">property</span><span style="color: blue">&gt;  <br />    &lt;</span><span style="color: #a31515">property </span><span style="color: red">name</span><span style="color: blue">=</span>&quot;<span style="color: blue">Sex</span>&quot; <span style="color: blue">/&gt;  <br />    &lt;</span><span style="color: #a31515">many-to-one </span><span style="color: red">name</span><span style="color: blue">=</span>&quot;<span style="color: blue">Mate</span>&quot; <span style="color: blue">/&gt;  <br />    &lt;</span><span style="color: #a31515">bag </span><span style="color: red">name</span><span style="color: blue">=</span>&quot;<span style="color: blue">Kittens</span>&quot;<span style="color: blue">&gt;  <br />      &lt;</span><span style="color: #a31515">key </span><span style="color: red">column</span><span style="color: blue">=</span>&quot;<span style="color: blue">mother_id</span>&quot; <span style="color: blue">/&gt;  <br />        &lt;</span><span style="color: #a31515">one-to-many </span><span style="color: red">class</span><span style="color: blue">=</span>&quot;<span style="color: blue">Cat</span>&quot; <span style="color: blue">/&gt;  <br />      &lt;/</span><span style="color: #a31515">bag</span><span style="color: blue">&gt;  <br />  &lt;/</span><span style="color: #a31515">class</span><span style="color: blue">&gt;  <br />&lt;/</span><span style="color: #a31515">hibernate-mapping</span><span style="color: blue">&gt;</span></pre><br /><br /><p>To this:</p><br /><br /><pre class="code"><span style="color: blue">public class </span><span style="color: #2b91af">CatMap </span>: ClassMap&lt;Cat&gt;<br />{<br />    <span style="color: blue">public </span>CatMap()<br />    {<br />        Id(x =&gt; x.Id);<br />        Map(x =&gt; x.Name)<br />          .Length(16)<br />          .Not.Nullable();<br />        Map(x =&gt; x.Sex);<br />        References(x =&gt; x.Mate);<br />        HasMany(x =&gt; x.Kittens);<br />    }<br />}</pre><br /><br /><p>What it gives you, you may ask? Compile-time checks and refactoring support, for a start.</p><br /><br /><h4>But wait, there is more!</h4><br /><br /><p>Fluent NHibernate is built with <a href="http://en.wikipedia.org/wiki/Convention_over_Configuration">Convention over Configuration</a> in mind. So, if you adhere to it, you can greatly reduce the amount of mapping needed, by virtue of <a href="http://wiki.fluentnhibernate.org/Auto_mapping">auto mapping</a>. And you can combine that with explicit ClassMap mappings, like the one above, they are not mutually exclusive.</p><br /><br /><p>Mapping your domain can be as simple as:</p><br /><br /><pre class="code">AutoMap.AssemblyOf&lt;Product&gt;();</pre><br /><br /><h4>And if you call within the next 5 minutes we throw in Conventions for free!</h4><br /><br /><p>&quot;Ok, that might be great for a greenfield project, but I am working in a big brown piece of ... code&quot;, I hear you saying. So you may not have the choice to call your Id's &quot;Id&quot; or name your tables exactly after your classes. <a href="http://wiki.fluentnhibernate.org/Conventions">Conventions</a> can greatly help here, allowing you to define your own conventions. That is, if your database naming follows any convention at all, and wasn't defined by a bunch of monkeys typing at random.</p><br /><br /><p>For further info, check the <a href="http://fluentnhibernate.org/">site</a>, <a href="http://wiki.fluentnhibernate.org/">wiki</a> and <a href="http://groups.google.com/group/fluent-nhibernate">mailing list</a>.</p><br /><br /><h4>AltNerdDinner's mappings</h4><br /><br /><p>Here are the mapping files for AltNerdDinner.</p><br /><br /><pre class="code"><span style="color: blue">public class </span><span style="color: #2b91af">DinnerMap </span>: <span style="color: #2b91af">ClassMap</span>&lt;<span style="color: #2b91af">Dinner</span>&gt;<br />{<br />    <span style="color: blue">public </span>DinnerMap()<br />    {<br />        Id(x =&gt; x.DinnerID);<br />        Map(x =&gt; x.Address).Not.Nullable();<br />        Map(x =&gt; x.ContactPhone).Not.Nullable();<br />        Map(x =&gt; x.Country).Not.Nullable();<br />        Map(x =&gt; x.Description).Not.Nullable();<br />        Map(x =&gt; x.EventDate).Not.Nullable();<br />        Map(x =&gt; x.HostedBy).Not.Nullable();<br />        Map(x =&gt; x.Latitude).Not.Nullable();<br />        Map(x =&gt; x.Longitude).Not.Nullable();<br />        Map(x =&gt; x.Title).Not.Nullable();<br />        HasMany(x =&gt; x.RSVPs).Cascade.AllDeleteOrphan();<br />    }<br />}</pre><br /><a href="http://11011.net/software/vspaste"></a><br /><br /><pre class="code"><span style="color: blue">public class </span><span style="color: #2b91af">RSVPMap </span>: <span style="color: #2b91af">ClassMap</span>&lt;<span style="color: #2b91af">RSVP</span>&gt;<br />{<br />    <span style="color: blue">public </span>RSVPMap()<br />    {<br />        Id(x =&gt; x.RsvpId);<br />        Map(x =&gt; x.AttendeeName).Not.Nullable();<br />        References(r =&gt; r.Dinner).<strong>Nullable()</strong>;            <br />    }<br />}</pre><br /><br /><p><a href="http://11011.net/software/vspaste"></a>One gotcha that had me fiddling around for a while was that Nullable part on the Dinner reference in RSVPMap. If you don't set it to nullable, you'll get an exception when trying to persist the entities. And even if you set it to nullable, you'll find out, NHibernate executes two queries to insert the RSVP.</p><br /><br /><blockquote><br />  <p>&#160;&#160;&#160; INSERT INTO&#160; [RSVP] (AttendeeName, Dinner_id) VALUES (@p0, @p1); <br />    <br />&#160;&#160;&#160; select SCOPE_IDENTITY(); <br /><br />    <br />&#160;&#160;&#160; @p0 = 'alberto', <br /><br />    <br />&#160;&#160;&#160; @p1 = 9 <br /><br />    <br />&#160;&#160;&#160; UPDATE [RSVP] SET Dinner_id = @p0 WHERE RsvpId = @p1; @p0 = 9, @p1 = 21</p><br /></blockquote><br /><br /><p>You can find <a href="http://nhforge.org/doc/nh/en/index.html#example-parentchild-bidir">more info</a> about this behavior in the <a href="http://nhforge.org/">official nhibernate site</a>.</p><br /><br /><p>So, what I have done instead is to set the RSVP as the managing part of the relationship, changing it back to not nullable and using Inverse() on the Dinner's mapping side.</p><br /><a href="http://11011.net/software/vspaste"></a><br /><br /><p>It is not possible to make the &quot;many part&quot; responsible for this. What this means is that we have to persist our entities calling:</p><br /><br /><pre class="code"><span style="color: #2b91af">Dinner </span>dinner = _dinnerRepository.GetDinner(id);<br /><span style="color: blue">var </span>rsvp = <span style="color: blue">new </span><span style="color: #2b91af">RSVP</span>{ AttendeeName = username };<br />rsvp.Dinner = dinner;<br />dinner.Rsvps.Add(rsvp);<br />_dinnerRepository.Save(dinner);</pre><br /><br /><p><a href="http://11011.net/software/vspaste"></a>That's not very ideal, so I have included an AddRsvp() method in Dinner to handle that. Now I have:</p><br /><br /><pre class="code"><span style="color: #2b91af">Dinner </span>dinner = _dinnerRepository.GetDinner(id);<br />dinner.AddRsvp(<span style="color: blue">new </span><span style="color: #2b91af">RSVP</span>{ AttendeeName = User.Identity.Name });<br />_dinnerRepository.Save(dinner);</pre><br /><br /><p>Much cleaner! In order to avoid confusion when adding an RSVO, I have changed the type of the collection to an IEnumerable&lt;RSVP&gt;, so that the collection cannot be modified directly, but only by means of Dinner (which is a good practice if you want to follow DDD, anyway). Because of that, I had to modified the DinnerMap to use a backing field for it. In the future I might revisit this relationship to include the User in the domain again and change it to a less CRUD-y style. You can read more on <a href="http://www.udidahan.com/2008/02/15/from-crud-to-domain-driven-fluency/">Domain-Driven fluency</a> from <a href="http://www.udidahan.com/2008/02/15/from-crud-to-domain-driven-fluency/">Udi Dahan</a>.</p><br /><br /><p>Anyway, here is the final mapping I have come up with:</p><br /><br /><pre class="code"><span style="color: blue">public class </span><span style="color: #2b91af">RSVPMap </span>: <span style="color: #2b91af">ClassMap</span>&lt;<span style="color: #2b91af">RSVP</span>&gt;<br />{<br />    <span style="color: blue">public </span>RSVPMap()<br />    {<br />        Id(x =&gt; x.RsvpId);<br />        Map(x =&gt; x.AttendeeName).Not.Nullable();<br />        References(r =&gt; r.Dinner).Not.Nullable();            <br />    }<br />}</pre><br /><a href="http://11011.net/software/vspaste"></a><br /><br /><pre class="code"><span style="color: blue">public class </span><span style="color: #2b91af">DinnerMap </span>: <span style="color: #2b91af">ClassMap</span>&lt;<span style="color: #2b91af">Dinner</span>&gt;<br />{<br />    <span style="color: blue">public </span>DinnerMap()<br />    {<br />        Id(x =&gt; x.DinnerID);<br />        Map(x =&gt; x.Address).Not.Nullable();<br />        Map(x =&gt; x.ContactPhone).Not.Nullable();<br />        Map(x =&gt; x.Country).Not.Nullable();<br />        Map(x =&gt; x.Description).Not.Nullable();<br />        Map(x =&gt; x.EventDate).Not.Nullable();<br />        Map(x =&gt; x.HostedBy).Not.Nullable();<br />        Map(x =&gt; x.Latitude).Not.Nullable();<br />        Map(x =&gt; x.Longitude).Not.Nullable();<br />        Map(x =&gt; x.Title).Not.Nullable();<br />        HasMany(x =&gt; x.Rsvps).Access.CamelCaseField(<span style="color: #2b91af">Prefix</span>.Underscore)<br />            .Inverse().Cascade.AllDeleteOrphan();<br />    }<br />}</pre>  </div>

]]></content>
  </entry>
  
</feed>
